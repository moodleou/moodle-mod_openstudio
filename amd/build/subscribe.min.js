/**
 * JavaScript to manage subscribe/unsubscribe feature.
 *
 * @package mod_openstudio
 * @copyright 2017 The Open University
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_openstudio/subscribe",["jquery","core/yui","core/templates","core/str","core/ajax","require"],(function($,Y,Templates,Str,ajax,require){var t;return t={dialogue:null,mconfig:null,CSS:{SUBSCRIBESETTING:".openstudio-subscribe-button",BOUNDINGBOX:".openstudio-subscribe-dialog-container",DIALOGHEADER:".openstudio-subscription-header",SUBSCRIBEBUTTON:'button[name="subscribebutton"]'},init:function(options){t.mconfig=options,Y.use("moodle-core-notification-dialogue",(function(){require(["mod_openstudio/osdialogue"],(function(osDialogue){t.dialogue=t.createSubscriptionDialogue(osDialogue,t.CSS.BOUNDINGBOX)}))})),$(t.CSS.SUBSCRIBEBUTTON).on("click",(function(){t.issubscribed()?t.unsubscribe():(t.dialogue.show(),t.resize())})),$(window).resize(t.resize.bind(t))},createSubscriptionDialogue:function(osDialogue,boundingBoxClass){var dialogue=new osDialogue({closeButton:!0,visible:!1,centered:!1,responsive:!0,focusOnPreviousTargetAfterHide:!0,extraClasses:[boundingBoxClass.replace(".","")]});return Str.get_string("subscriptiondialogheader","mod_openstudio").done((function(s){dialogue.set("headerContent",'<span class="'+t.CSS.DIALOGHEADER.replace(".","")+'">'+s+"</span>")})),Templates.render("mod_openstudio/subscribe_dialog",t.mconfig.constants).done((function(html){dialogue.set("bodyContent",html)})),Str.get_strings([{key:"subscriptiondialogcancel",component:"mod_openstudio"},{key:"subscribe",component:"mod_openstudio"}]).done((function(s){var cancelBtnProperty={name:"cancel",label:s[0],classNames:"openstudio-cancel-btn",action:"hide"};dialogue.addButton(cancelBtnProperty,["footer"]);var subscribeBtnProperty={name:"subscribe",label:s[1],classNames:"openstudio-subscript-btn",events:{click:t.subscribe.bind(t)}};dialogue.addButton(subscribeBtnProperty,["footer"])})),dialogue},subscribe:function(){var args;t.dialogue.hide(),args={openstudioid:t.mconfig.openstudioid,emailformat:$('select[name="openstudio-subscription-email-format"]').val(),frequency:$('select[name="openstudio-subscription-email-frequency"]').val(),userid:t.mconfig.userid},M.util.js_pending("openstudioSubscribe"),ajax.call([{methodname:"mod_openstudio_external_subscribe",args:args}])[0].done((function(res){var subscriptionid;subscriptionid=res.subscriptionid,Str.get_string("unsubscribe","mod_openstudio").done((function(s){$(t.CSS.SUBSCRIBEBUTTON).text(s),$("#openstudio_subscribe_button").focus()})),$(t.CSS.SUBSCRIBEBUTTON).attr("subscriptionid",subscriptionid)})).always((function(){M.util.js_complete("openstudioSubscribe")})).fail((function(ex){window.console.error("Log request failed "+ex.message)}))},unsubscribe:function(){var args;args={subscriptionid:$(t.CSS.SUBSCRIBEBUTTON).attr("subscriptionid"),userid:t.mconfig.userid,cmid:t.mconfig.cmid},M.util.js_pending("openstudioUnsubscribe"),ajax.call([{methodname:"mod_openstudio_external_unsubscribe",args:args}])[0].done((function(){Str.get_string("subscribetothisstudio","mod_openstudio").done((function(s){$(t.CSS.SUBSCRIBEBUTTON).text(s)})),$(t.CSS.SUBSCRIBEBUTTON).removeAttr("subscriptionid")})).always((function(){M.util.js_complete("openstudioUnsubscribe")})).fail((function(ex){window.console.warn("Log request failed "+ex.message)}))},issubscribed:function(){return $(t.CSS.SUBSCRIBEBUTTON)[0].hasAttribute("subscriptionid")},resize:function(){var visible=t.dialogue.get("visible");if(Y.one("body").get("winWidth")>767){var dialoguetop=$(t.CSS.SUBSCRIBESETTING).offset().top+3,dialogueleft=$(t.CSS.SUBSCRIBESETTING).offset().left-330;if(t.dialogue.get("boundingBox").setStyles({top:dialoguetop,left:dialogueleft,width:316}),"large"==t.sizing)return;t.dialogue.hide(),t.sizing="large",visible&&t.dialogue.show(),t.dialogue.get("boundingBox").setStyles({top:dialoguetop,left:dialogueleft,width:316})}else{if("small"==t.sizing)return;t.sizing="small",t.dialogue.hide(),visible&&t.dialogue.show(),$(t.CSS.BOUNDINGBOX).parent().appendTo($("body"))}}}}));

//# sourceMappingURL=subscribe.min.js.map