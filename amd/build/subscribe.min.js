/**
 * JavaScript to manage subscribe/unsubscribe feature.
 *
 * @package
 * @copyright 2017 The Open University
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_openstudio/subscribe",["jquery","core/templates","core/str","core/ajax","mod_openstudio/osdialogue"],(function($,Templates,Str,ajax,osDialogue){var t;return t={dialogue:null,mconfig:null,CSS:{SUBSCRIBESETTING:".openstudio-subscribe-button",BOUNDINGBOX:".openstudio-subscribe-dialog-container",DIALOGHEADER:".openstudio-subscription-header",SUBSCRIBEBUTTON:'button[name="subscribebutton"]'},init:async function(options){t.mconfig=options,t.dialogue=await t.createSubscriptionDialogue(),$(t.CSS.SUBSCRIBEBUTTON).on("click",(function(){t.issubscribed()?t.unsubscribe():t.dialogue.show()}))},createSubscriptionDialogue:async function(){const dialogue=await osDialogue.create({isVerticallyCentered:!0,templateContext:{extraClasses:t.CSS.BOUNDINGBOX.replace(".","")}});return function(dialogue){Str.get_string("subscriptiondialogheader","mod_openstudio").done((function(s){dialogue.setTitle('<span class="'+t.CSS.DIALOGHEADER.replace(".","")+'">'+s+"</span>")}))}(dialogue),function(dialogue){Templates.render("mod_openstudio/subscribe_dialog",t.mconfig.constants).done((function(html){dialogue.setBody(html)}))}(dialogue),function(dialogue){Str.get_strings([{key:"subscriptiondialogcancel",component:"mod_openstudio"},{key:"subscribe",component:"mod_openstudio"}]).done((function(s){const cancelBtnProperty={name:"cancel",label:s[0],classNames:"openstudio-cancel-btn",action:"hide"};dialogue.addButton(cancelBtnProperty,["footer"]);const subscribeBtnProperty={name:"subscribe",label:s[1],classNames:"openstudio-subscript-btn",events:{click:t.subscribe.bind(t)}};dialogue.addButton(subscribeBtnProperty,["footer"])}))}(dialogue),dialogue},subscribe:function(){var args;t.dialogue.hide(),args={openstudioid:t.mconfig.openstudioid,emailformat:$('select[name="openstudio-subscription-email-format"]').val(),frequency:$('select[name="openstudio-subscription-email-frequency"]').val(),userid:t.mconfig.userid},M.util.js_pending("openstudioSubscribe"),ajax.call([{methodname:"mod_openstudio_external_subscribe",args:args}])[0].done((function(res){var subscriptionid;subscriptionid=res.subscriptionid,Str.get_string("unsubscribe","mod_openstudio").done((function(s){$(t.CSS.SUBSCRIBEBUTTON).text(s),$("#openstudio_subscribe_button").focus()})),$(t.CSS.SUBSCRIBEBUTTON).attr("subscriptionid",subscriptionid)})).always((function(){M.util.js_complete("openstudioSubscribe")})).fail((function(ex){window.console.error("Log request failed "+ex.message)}))},unsubscribe:function(){var args;args={subscriptionid:$(t.CSS.SUBSCRIBEBUTTON).attr("subscriptionid"),userid:t.mconfig.userid,cmid:t.mconfig.cmid},M.util.js_pending("openstudioUnsubscribe"),ajax.call([{methodname:"mod_openstudio_external_unsubscribe",args:args}])[0].done((function(){Str.get_string("subscribetothisstudio","mod_openstudio").done((function(s){$(t.CSS.SUBSCRIBEBUTTON).text(s)})),$(t.CSS.SUBSCRIBEBUTTON).removeAttr("subscriptionid")})).always((function(){M.util.js_complete("openstudioUnsubscribe")})).fail((function(ex){window.console.warn("Log request failed "+ex.message)}))},issubscribed:function(){return $(t.CSS.SUBSCRIBEBUTTON)[0].hasAttribute("subscriptionid")}}}));

//# sourceMappingURL=subscribe.min.js.map