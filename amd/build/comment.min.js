/**
 * JavaScript to manage comment feature.
 *
 * @package
 * @copyright 2017 The Open University
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_openstudio/comment",["jquery","core/ajax","core/str","mod_openstudio/scrollto","require","core/notification","core_form/changechecker","core/fragment","core/templates"],(function($,Ajax,Str,Scrollto,require,Notification,FormChangeChecker,Fragment,Templates){var t;return t={mconfig:null,HEIGHT_TO_TOP:100,CSS:{ADD_NEW_BUTTON:"#id_addcomment",REPLY_BUTTON:'input[name="replycommentbutton"]',LIKE_BUTTON:".openstudio-comment-flag-link",DELETE_BUTTON:".openstudio-comment-delete-link",DELETE_CONFIRM_BUTTON:".openstudio-comment-delete-btn",COMMENT_FORM_CONTENT:".openstudio-comment-form-content",COMMENT_FORM:".openstudio-comment-form",COMMENT_REPLY_FORM:".openstudio-comment-reply-form",COMMENT_ATTACHMENT:".openstudio-comment-form-content .filepicker-filename > a",COMMENT_FORM_BODY:".openstudio-comment-form-body",COMMENT_POST_BUTTON:"#id_postcomment",COMMENT_LOADING:".openstudio-comment-loading",COMMENT_THREAD:".openstudio-comment-thread",COMMENT_THREAD_BODY:".openstudio-comment-thread-body",REPLY_THREAD:".openstudio-comment-thread-replied-items",COMMENT_ITEM:".openstudio-comment-thread-item",FLAG_COUNT:".openstudio-comment-flag-count",FLAG_STATUS:".openstudio-comment-flag-status",DIALOG_HEADER:".openstudio-comment-delete-header",BOUNDING_BOX:".openstudio-comment-dialogue-container"},SELECTOR:{COMMENT_BOX_ID:"#id_commentext"},init:function(options){t.mconfig=options,Y.use("moodle-core-notification-dialogue",(function(){require(["mod_openstudio/osdialogue"],(function(osDialogue){t.dialogue=t.createDeleteCommentDialogue(osDialogue)}))})),$(t.CSS.ADD_NEW_BUTTON).on("click",t.showCommentForm.bind(t)),$("body").delegate(t.CSS.REPLY_BUTTON,"click",t.showReplyForm).delegate(t.CSS.LIKE_BUTTON,"click",t.likeComment).delegate(t.CSS.DELETE_BUTTON,"click",t.deleteConfirm).delegate(t.CSS.DELETE_CONFIRM_BUTTON,"click",t.deleteComment),$(t.CSS.COMMENT_FORM).find("form").on("submit",t.postComment),$(window).resize(t.resize)},focusTextArea:function(textAreaId){const atto=$(textAreaId+"editable");atto.attr("contenteditable","true"),atto.focus()},showCommentForm:function(){$(t.CSS.COMMENT_FORM_CONTENT).show(),t.resetForm(),$(t.CSS.ADD_NEW_BUTTON).hide(),$(t.CSS.COMMENT_REPLY_FORM).hide(),$("#openstudio_comment_form").focus(),t.focusTextArea(t.SELECTOR.COMMENT_BOX_ID)},showReplyForm:function(){$(t.CSS.COMMENT_REPLY_FORM).hide(),$(t.CSS.COMMENT_FORM).find(t.CSS.COMMENT_FORM_CONTENT).hide(),$(t.CSS.ADD_NEW_BUTTON).show();var commentid=$(this).data("comment-parent").trim(),replyform=$(t.CSS.COMMENT_THREAD).filter((function(){return $(this).data("thread-items")==commentid})).find(t.CSS.COMMENT_REPLY_FORM);if(replyform.show(),replyform.find("form").length)t.showReplyFormPostProcess(replyform,commentid);else{var loading=$(t.CSS.COMMENT_LOADING).clone().show();replyform.append(loading),M.util.js_pending("openstudioloadfragmentform");var appendselector=replyform.find(t.CSS.COMMENT_FORM_BODY);t.loadFragmentForm(commentid).then((function(html,js){Templates.replaceNodeContents(appendselector,html,js),appendselector.find("form").submit((function(e){e.preventDefault()})),appendselector.find("form").on("submit",t.postComment),replyform.find(t.CSS.COMMENT_LOADING).remove(),M.util.js_complete("openstudioloadfragmentform")})).then(function(){t.showReplyFormPostProcess(replyform,commentid)}.bind(t)).fail(Notification.exception)}},showReplyFormPostProcess:function(replyForm,commentId){replyForm.find(t.CSS.COMMENT_FORM_CONTENT).show(),t.resetForm(),replyForm.find('form input[name="inreplyto"]').val(parseInt(commentId)),Scrollto.scrollToEl(replyForm,t.HEIGHT_TO_TOP)},loadFragmentForm:function(commentId){var params=[];return params.id=t.mconfig.cmid,params.cid=t.mconfig.cid,params.max_bytes=t.mconfig.max_bytes,params.attachmentenable=t.mconfig.attachmentenable,commentId&&(params.replyid=commentId),Fragment.loadFragment("mod_openstudio","commentform",t.mconfig.contextid,params)},resetForm:function(){$(t.CSS.COMMENT_FORM_CONTENT).find(".editor_atto_content").html(""),$(t.CSS.COMMENT_FORM_CONTENT).find('form input[name="inreplyto"]').val(0),setTimeout((function(){window.tinyMCE&&window.tinyMCE.activeEditor&&window.tinyMCE.activeEditor.setContent(""),$(t.CSS.COMMENT_FORM_CONTENT+":visible").find("form").get(0).reset()}),0),$(t.CSS.COMMENT_ATTACHMENT).remove()},postComment:function(e){e.preventDefault(),e.stopImmediatePropagation();var formdata={};$.each($(this).serializeArray(),(function(i,field){formdata[field.name]=field.value}));var hasAttachment=$(t.CSS.COMMENT_ATTACHMENT).length>0;(hasAttachment||0!=formdata["commentext[text]"].length)&&(M.util.js_pending("openstudioPostComment"),Ajax.call([{methodname:"mod_openstudio_external_add_comment",args:{cmid:formdata.cmid,cid:formdata.cid,inreplyto:parseInt(formdata.inreplyto.trim()),commenttext:formdata["commentext[text]"],commenttextitemid:formdata["commentext[itemid]"],commentattachment:hasAttachment?formdata.commentattachment:0}}])[0].done((function(res){$(t.CSS.ADD_NEW_BUTTON).show(),$(t.CSS.COMMENT_FORM_CONTENT).hide(),$(t.CSS.COMMENT_REPLY_FORM).hide();var commentparent=parseInt(formdata.inreplyto.trim());commentparent?($(t.CSS.COMMENT_THREAD).filter((function(){return $(this).data("thread-items")==commentparent})).find(t.CSS.REPLY_THREAD).find(t.CSS.COMMENT_ITEM).last().before(res.commenthtml),Scrollto.scrollToEl($('[data-thread-item="'+res.commentid+'"]'),t.HEIGHT_TO_TOP)):($(t.CSS.COMMENT_THREAD_BODY).append(res.commenthtml),Scrollto.scrollToEl($('[data-thread-items="'+res.commentid+'"]'),t.HEIGHT_TO_TOP)),t.resize(),$(t.CSS.COMMENT_THREAD).show(),$("#openstudio_comment_form").focus(),t.focusTextArea(t.SELECTOR.COMMENT_BOX_ID),window.oump&&window.oump.harvest(),FormChangeChecker.resetFormDirtyState($(t.CSS.COMMENT_POST_BUTTON)[0])})).always((function(){M.util.js_complete("openstudioPostComment")})).fail(Notification.exception))},likeComment:function(e){e.preventDefault();var likebtn=$(this);M.util.js_pending("openstudioLikeComment"),Ajax.call([{methodname:"mod_openstudio_external_flag_comment",args:{cmid:t.mconfig.cmid,cid:t.mconfig.cid,commentid:likebtn.data("comment-id"),fid:t.mconfig.fid}}])[0].done((function(res){let likeicon=likebtn.siblings(t.CSS.FLAG_STATUS+".flagged"),notlikeicon=likebtn.siblings(t.CSS.FLAG_STATUS+".unflagged");if(likebtn.siblings(t.CSS.FLAG_STATUS).children(t.CSS.FLAG_COUNT).text(res.count).parent().removeClass("openstudio-hidden").siblings(t.CSS.FLAG_STATUS).addClass("openstudio-hidden"),0===res.count){let imageElement=likebtn.siblings(t.CSS.FLAG_STATUS).children("img");imageElement&&Str.get_string("contentcommentnotliked","mod_openstudio").then((value=>{imageElement[1].alt=value,imageElement[1].title=value}))}likebtn.children().each((function(){var elem=$(this);(elem.hasClass("openstudio-comment-like-long-link")||elem.hasClass("openstudio-comment-like-short-link")||elem.hasClass("openstudio-comment-unlike-long-link")||elem.hasClass("openstudio-comment-unlike-short-link"))&&(elem.hasClass("openstudio-hidden")?(elem.removeClass("openstudio-hidden"),likeicon.removeClass("openstudio-hidden"),notlikeicon.addClass("openstudio-hidden")):(elem.addClass("openstudio-hidden"),likeicon.addClass("openstudio-hidden"),notlikeicon.removeClass("openstudio-hidden")))}),this)})).always((function(){M.util.js_complete("openstudioLikeComment")})).fail((function(ex){window.console.error("Log request failed "+ex.message)}))},deleteComment:function(){var commentid=parseInt($(this).attr("data-comment-id"));M.util.js_pending("openstudioDeleteComment"),Ajax.call([{methodname:"mod_openstudio_external_delete_comment",args:{cmid:t.mconfig.cmid,commentid:commentid}}])[0].done((function(){var commenttream=$('[data-thread-items="'+commentid+'"]'),replyitem=$('[data-thread-item="'+commentid+'"]');commenttream.length>0?commenttream.remove():replyitem.remove(),0==$("div[data-thread-items]").length&&$(t.CSS.COMMENT_THREAD).hide(),t.dialogue.hide(),t.dialogue.after("visibleChange",(function(){$("#openstudio_comment_form").focus()}),t.dialogue)})).always((function(){M.util.js_complete("openstudioDeleteComment")})).fail((function(ex){window.console.error("Log request failed "+ex.message)}))},createDeleteCommentDialogue:function(osDialogue){var folderClass="";t.mconfig.folder&&(folderClass="openstudio-folder");var dialogue=new osDialogue({closeButton:!0,visible:!1,centered:!0,responsive:!0,responsiveWidth:767,modal:!0,focusOnPreviousTargetAfterHide:!0,width:521,extraClasses:[t.CSS.BOUNDING_BOX.replace(".",""),folderClass]}),cancelBtnProperty={name:"cancel",classNames:"openstudio-cancel-btn",action:"hide"},deleteBtnProperty={name:"delete",classNames:t.CSS.DELETE_CONFIRM_BUTTON.replace(".","")};return Str.get_strings([{key:"contentcommentsdelete",component:"mod_openstudio"},{key:"modulejsdialogcommentdeleteconfirm",component:"mod_openstudio"},{key:"modulejsdialogcancel",component:"mod_openstudio"},{key:"modulejsdialogdelete",component:"mod_openstudio"}]).done((function(s){cancelBtnProperty.label=s[2],deleteBtnProperty.label=s[3],dialogue.set("headerContent",'<span class="openstudio-dialogue-common-header '+t.CSS.DIALOG_HEADER.replace(".","")+'">'+s[0]+"</span>"),dialogue.set("bodyContent",s[1]),dialogue.addButton(deleteBtnProperty,["footer"]),dialogue.addButton(cancelBtnProperty,["footer"])})),dialogue},deleteConfirm:function(e){e.preventDefault(),t.dialogue&&($(t.CSS.DELETE_CONFIRM_BUTTON).attr("data-comment-id",$(this).data("comment-id")),t.dialogue.show())},resize:function(){t.dialogue&&t.dialogue.get("visible")&&(Y.one("body").get("winWidth")<=t.dialogue.get("responsiveWidth")?t.dialogue.makeResponsive():t.dialogue.centerDialogue())}}}));

//# sourceMappingURL=comment.min.js.map