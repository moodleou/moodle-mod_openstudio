define ("mod_openstudio/comment",["jquery","core/ajax","core/str","mod_openstudio/scrollto","require"],function(a,b,c,d,e){var f={mconfig:null,HEIGHT_TO_TOP:100,CSS:{ADD_NEW_BUTTON:"#id_addcomment",REPLY_BUTTON:"input[name=\"replycommentbutton\"]",LIKE_BUTTON:".openstudio-comment-flag-link",DELETE_BUTTON:".openstudio-comment-delete-link",DELETE_CONFIRM_BUTTON:".openstudio-comment-delete-btn",COMMENT_FORM_CONTENT:".openstudio-comment-form-content",COMMENT_FORM:".openstudio-comment-form",COMMENT_REPLY_FORM:".openstudio-comment-reply-form",COMMENT_ATTACHMENT:".openstudio-comment-form-content .filepicker-filename > a",COMMENT_THREAD:".openstudio-comment-thread",COMMENT_THREAD_BODY:".openstudio-comment-thread-body",REPLY_THREAD:".openstudio-comment-thread-replied-items",COMMENT_ITEM:".openstudio-comment-thread-item",FLAG_COUNT:".openstudio-comment-flag-count",FLAG_STATUS:".openstudio-comment-flag-status",DIALOG_HEADER:".openstudio-comment-delete-header",BOUNDING_BOX:".openstudio-comment-dialogue-container"},init:function init(b){f.mconfig=b;Y.use("moodle-core-notification-dialogue",function(){e(["mod_openstudio/osdialogue"],function(a){f.dialogue=f.createDeleteCommentDialogue(a)})});a(f.CSS.ADD_NEW_BUTTON).on("click",f.showCommentForm.bind(f));a("body").delegate(f.CSS.REPLY_BUTTON,"click",f.showReplyForm).delegate(f.CSS.LIKE_BUTTON,"click",f.likeComment).delegate(f.CSS.DELETE_BUTTON,"click",f.deleteConfirm).delegate(f.CSS.DELETE_CONFIRM_BUTTON,"click",f.deleteComment);a(f.CSS.COMMENT_FORM).find("form").on("submit",f.postComment);a(window).resize(f.resize)},showCommentForm:function showCommentForm(){a(f.CSS.COMMENT_FORM_CONTENT).appendTo(f.CSS.COMMENT_FORM);a(f.CSS.COMMENT_FORM_CONTENT).show();f.resetForm();a(f.CSS.ADD_NEW_BUTTON).hide();a(f.CSS.COMMENT_REPLY_FORM).hide();d.scrollToEl(a(f.CSS.COMMENT_FORM_CONTENT),f.HEIGHT_TO_TOP);a("#openstudio_comment_form").focus()},showReplyForm:function showReplyForm(){var b=a(this).data("comment-parent").trim(),c=a(f.CSS.COMMENT_THREAD).filter(function(){return a(this).data("thread-items")==b}).find(f.CSS.COMMENT_REPLY_FORM);a(f.CSS.COMMENT_FORM_CONTENT).appendTo(c);c.show();a(f.CSS.COMMENT_FORM_CONTENT).show();f.resetForm();a(f.CSS.ADD_NEW_BUTTON).show();a(f.CSS.COMMENT_FORM_CONTENT).find("form input[name=\"inreplyto\"]").val(parseInt(b));d.scrollToEl(c,f.HEIGHT_TO_TOP)},resetForm:function resetForm(){a(f.CSS.COMMENT_FORM_CONTENT).find(".editor_atto_content").html("");a(f.CSS.COMMENT_FORM_CONTENT).find("form input[name=\"inreplyto\"]").val(0);a(f.CSS.COMMENT_FORM_CONTENT).find("form").get(0).reset();a(f.CSS.COMMENT_ATTACHMENT).remove()},postComment:function postComment(c){c.preventDefault();c.stopImmediatePropagation();var e={};a.each(a(this).serializeArray(),function(a,b){e[b.name]=b.value});var g=0<a(f.CSS.COMMENT_ATTACHMENT).length;if(!g&&0==e["commentext[text]"].length){return}M.util.js_pending("openstudioPostComment");var h=b.call([{methodname:"mod_openstudio_external_add_comment",args:{cmid:e.cmid,cid:e.cid,inreplyto:parseInt(e.inreplyto.trim()),commenttext:e["commentext[text]"],commentattachment:g?e.commentattachment:0}}]);h[0].done(function(b){a(f.CSS.ADD_NEW_BUTTON).show();a(f.CSS.COMMENT_FORM_CONTENT).hide();a(f.CSS.COMMENT_REPLY_FORM).hide();var c=parseInt(e.inreplyto.trim());if(c){a(f.CSS.COMMENT_THREAD).filter(function(){return a(this).data("thread-items")==c}).find(f.CSS.REPLY_THREAD).find(f.CSS.COMMENT_ITEM).last().before(b.commenthtml);d.scrollToEl(a("[data-thread-item=\""+b.commentid+"\"]"),f.HEIGHT_TO_TOP)}else{a(f.CSS.COMMENT_THREAD_BODY).append(b.commenthtml);d.scrollToEl(a("[data-thread-items=\""+b.commentid+"\"]"),f.HEIGHT_TO_TOP)}f.resize();a(f.CSS.COMMENT_THREAD).show();a("#openstudio_comment_form").focus();if(window.oump){window.oump.harvest()}}).always(function(){M.util.js_complete("openstudioPostComment")}).fail(function(a){window.console.error("Log request failed "+a.message)})},likeComment:function likeComment(c){c.preventDefault();var d=a(this);M.util.js_pending("openstudioLikeComment");var e=b.call([{methodname:"mod_openstudio_external_flag_comment",args:{cmid:f.mconfig.cmid,cid:f.mconfig.cid,commentid:d.data("comment-id")}}]);e[0].done(function(a){d.hide().siblings(f.CSS.FLAG_STATUS+".flagged").children(f.CSS.FLAG_COUNT).addClass("flagged").text(a.count).parent().removeClass("openstudio-hidden").siblings(f.CSS.FLAG_STATUS+".unflagged").addClass("openstudio-hidden")}).always(function(){M.util.js_complete("openstudioLikeComment")}).fail(function(a){window.console.error("Log request failed "+a.message)})},deleteComment:function deleteComment(){var c=parseInt(a(this).attr("data-comment-id"));M.util.js_pending("openstudioDeleteComment");var d=b.call([{methodname:"mod_openstudio_external_delete_comment",args:{cmid:f.mconfig.cmid,commentid:c}}]);d[0].done(function(){a(f.CSS.COMMENT_FORM_CONTENT).appendTo(f.CSS.COMMENT_FORM);var b=a("[data-thread-items=\""+c+"\"]"),d=a("[data-thread-item=\""+c+"\"]");if(0<b.length){b.remove()}else{d.remove()}if(0==a("div[data-thread-items]").length){a(f.CSS.COMMENT_THREAD).hide()}f.dialogue.hide();f.dialogue.after("visibleChange",function(){a("#openstudio_comment_form").focus()},f.dialogue)}).always(function(){M.util.js_complete("openstudioDeleteComment")}).fail(function(a){window.console.error("Log request failed "+a.message)})},createDeleteCommentDialogue:function createDeleteCommentDialogue(a){var b=new a({closeButton:!0,visible:!1,centered:!0,responsive:!0,responsiveWidth:767,modal:!0,focusOnPreviousTargetAfterHide:!0,width:521,extraClasses:[f.CSS.BOUNDING_BOX.replace(".","")]}),d={name:"cancel",classNames:"openstudio-cancel-btn",action:"hide"},e={name:"delete",classNames:f.CSS.DELETE_CONFIRM_BUTTON.replace(".","")};c.get_strings([{key:"contentcommentsdelete",component:"mod_openstudio"},{key:"modulejsdialogcommentdeleteconfirm",component:"mod_openstudio"},{key:"modulejsdialogcancel",component:"mod_openstudio"},{key:"modulejsdialogdelete",component:"mod_openstudio"}]).done(function(a){d.label=a[2];e.label=a[3];b.set("headerContent","<span class=\"openstudio-dialogue-common-header "+f.CSS.DIALOG_HEADER.replace(".","")+"\">"+a[0]+"</span>");b.set("bodyContent",a[1]);b.addButton(e,["footer"]);b.addButton(d,["footer"])});return b},deleteConfirm:function deleteConfirm(b){b.preventDefault();if(f.dialogue){a(f.CSS.DELETE_CONFIRM_BUTTON).attr("data-comment-id",a(this).data("comment-id"));f.dialogue.show()}},resize:function resize(){if(!f.dialogue){return}if(f.dialogue.get("visible")){if(Y.one("body").get("winWidth")<=f.dialogue.get("responsiveWidth")){f.dialogue.makeResponsive()}else{f.dialogue.centerDialogue()}}}};return f});
//# sourceMappingURL=comment.min.js.map
