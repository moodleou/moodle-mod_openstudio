/**
 * Javascript functionality for the notifications list in the header.
 *
 * @package
 * @copyright  2017 The Open University
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or lat
 */
define("mod_openstudio/notificationlist",["jquery","core/ajax","core/modal","core/templates"],(function($,Ajax,Modal,Templates){var SELECTORS_STOPBUTTONS=".openstudio-notification-stopbutton",SELECTORS_NOTIFICATIONBUTTON=".openstudio-nav-primary .dropdown.notifications",SELECTORS_UNREAD=".openstudio-notifications-list .openstudio-notification-unread",priv={cmid:null,followflag:null},t={modal:null,init:function(cmid,followflag){priv.cmid=cmid,priv.followflag=followflag,$(SELECTORS_STOPBUTTONS).on("click",t.stopNotifications),$(SELECTORS_UNREAD).length>0&&$(SELECTORS_NOTIFICATIONBUTTON).on("click",t.readNotifications),Templates.render("mod_openstudio/notification_modal",{name:""}),Templates.render("core/modal_backdrop",{})},reShowList:function(){window.setTimeout((function(){$(SELECTORS_NOTIFICATIONBUTTON).addClass("open")}),0)},stopNotifications:function(e){var template;e.preventDefault(),t.reShowList();var notification=$(e.target).closest(".openstudio-notification"),contentid=$(e.currentTarget).data("contentid"),commentid=$(e.currentTarget).data("commentid");template=commentid?"mod_openstudio/commentnotification_modal":"mod_openstudio/notification_modal",Templates.render(template,{name:notification.find(".openstudio-notification-message a").text(),contentid:contentid,commentid:commentid}).done((function(html){t.modal=new Modal(html),t.modal.body.find("button").on("click",t.handleModalButton),t.modal.show()}))},handleModalButton:function(e){t.reShowList();var target=$(e.target);if("yes"===target.data("action")){var method;M.util.js_pending("openstudioStopNotifications");var commentid=target.data("commentid"),args={cmid:priv.cmid,cid:target.data("contentid"),fid:priv.followflag};commentid?(args.commentid=commentid,method="mod_openstudio_external_flag_comment"):(args.mode="off",method="mod_openstudio_external_flag_content"),Ajax.call([{methodname:method,args:args}])[0].done((function(){$('.openstudio-notifications-list button[data-contentid="'+target.data("contentid")+'"]').remove(),M.util.js_complete("openstudioStopNotifications")})).fail((function(){window.console.error("Could not un-follow content"),M.util.js_complete("openstudioStopNotifications")}))}t.modal.hide()},readNotifications:function(e){e.preventDefault();var ids=$(SELECTORS_UNREAD).map((function(){return $(this).data("id")})).get();Ajax.call([{methodname:"mod_openstudio_external_read_notifications",args:{cmid:priv.cmid,ids:ids}}])[0].done((function(){$(".openstudio-navigation-notification-text").hide(),$(SELECTORS_NOTIFICATIONBUTTON).off("click",t.readNotifications)})).fail((function(ex){window.console.error("Could not mark notifications read. "+ex.message)}))}};return t}));

//# sourceMappingURL=notificationlist.min.js.map