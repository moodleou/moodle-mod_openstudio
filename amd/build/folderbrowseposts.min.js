define(["jquery","amd/build/isotope.pkgd.min.js","core/str","core/templates","core/ajax"],function(a,b,c,d,e){var f;return f={mconfig:null,selectedposts:[],totalavailablepost:0,CSS:{BROWSEPOSTLINK:".openstudio-select-content",BROWSEPOSTSSELECTEDIDS:"#browse_posts_selected_ids",BROWSEPOSTSSELECTEDITEMS:"#browse_posts_selected_items",SELECTPOSTBTN:".openstudio-folder-select-post-btn",BROWSEPOSTSSELECTED:"#browse_posts_selected",BROWSEPOSTSCOUNTSELECTED:"#openstudio-browseposts-countcurrent",REMOVELASTSELECTED:".folder-browse-post-remove-last-selection",SAVECHANGEBUTTON:".folder-browse-post-save-change",DIALOGHEADER:".openstudio-dialogue-common-header",BROWSEPOSTDIALOGUECONTAINER:".openstudio-folder-posts-dialogue"},init:function(b){f.mconfig=b,Y.use("moodle-core-notification-dialogue",function(){require(["mod_openstudio/osdialogue"],function(a){f.dialogue=f.createBrowseDialogue(a)})}),a(f.CSS.BROWSEPOSTLINK).on("click",function(){f.dialogue.show(),d.render("mod_openstudio/folder_browse_posts_header",{}).done(function(b){return f.selectedposts=[],f.dialogue.set("bodyContent",b),setTimeout(function(){f.resize()},200),a("#openstudio_search_post").keypress(function(a){var b=a.which;return 13!=b||(f.doBrowsePosts(),!1)}),a(".browse-search-icon").on("click",function(){f.doBrowsePosts()}),f.doBrowsePosts(),a(f.CSS.REMOVELASTSELECTED).on("click",function(){f.removeLastPostSelected()}),!1})}),a(window).resize(f.resize.bind(f))},doBrowsePosts:function(){var b=e.call([{methodname:"mod_openstudio_external_browse_posts",args:{cmid:f.mconfig.cmid,folderid:f.mconfig.folderid,selectedposts:a(f.CSS.BROWSEPOSTSSELECTEDIDS).val(),search:a("#openstudio_search_post").val()}}]);b[0].done(function(b){f.totalavailablepost=b.total,a("#folder_total_browse_posts").html(b.foundnumberpostlabel),a("#openstudio-browseposts-total").html(b.total),a("#openstudio-browseposts-helpicon").html(b.helpicon),a("#browse_posts_searched").html(b.html),a(f.CSS.SELECTPOSTBTN).on("click",function(){f.selectPostToFolder(this)}),a(f.CSS.SAVECHANGEBUTTON).on("click",function(){f.selectedposts.length&&a("#browse_posts_selected_from").submit()}),f.hideSaveButtons(),f.showHideSelectButton(),a(f.CSS.REMOVELASTSELECTED).on("click",function(){f.removeLastPostSelected()}),f.updateBackgroundRow()}).fail(function(a){window.console.error("Browse posts failed "+a.message)})},createBrowseDialogue:function(a){function b(){var a="folderbrowseposts";c.get_string(a,"mod_openstudio").done(function(a){d.set("headerContent",'<span class="'+f.CSS.DIALOGHEADER.replace(".","")+'">'+a+"</span>")})}var d=new a({closeButton:!0,visible:!1,centered:!0,modal:!0,responsive:!0,width:640,responsiveWidth:767,focusOnPreviousTargetAfterHide:!0,extraClasses:[f.CSS.BROWSEPOSTDIALOGUECONTAINER.replace(".","")]});return b(),d},selectPostToFolder:function(b){var c=a(b).attr("value"),e=a("#browse_post_item_img_"+c).attr("src"),g=M.util.image_url("close_button_whitecross_rgb_32px","mod_openstudio"),h=a("#browse_post_item_name_"+c).val(),i="deselect-"+c;d.render("mod_openstudio/folder_browse_selected_post",{buttonid:i,postid:c,image:e,closeicon:g,title:h}).done(function(b){a(f.CSS.BROWSEPOSTSSELECTEDITEMS).append(b),a("#deselect-"+c).on("click",function(){var b=a(this).attr("value");f.deSelectPostToFolder(b)}),f.showHideSelectButton()}),a("#browse_post_item_"+c).hide(),f.selectedposts.push(c),a(f.CSS.BROWSEPOSTSSELECTEDIDS).val(f.selectedposts),a(f.CSS.BROWSEPOSTSSELECTED).show();var j=f.selectedposts.length;a(f.CSS.BROWSEPOSTSCOUNTSELECTED).html(j),f.showSaveButtons(),f.updateBackgroundRow()},deSelectPostToFolder:function(b){a("#browse_post_item_"+b).show(),a("#deselect-"+b).remove(),f.selectedposts.splice(a.inArray(b,f.selectedposts),1),a(f.CSS.BROWSEPOSTSSELECTEDIDS).val(f.selectedposts);var c=f.selectedposts.length;a(f.CSS.BROWSEPOSTSCOUNTSELECTED).html(c),0==c&&a(f.CSS.BROWSEPOSTSSELECTED).hide(),f.hideSaveButtons(),f.showHideSelectButton(),f.updateBackgroundRow()},removeLastPostSelected:function(){var a=f.selectedposts[f.selectedposts.length-1];f.deSelectPostToFolder(a)},hideSaveButtons:function(){var b=f.selectedposts.length;0==b&&(a(".openstudio-folder-browse-posts-header-result-buttons").hide(),a(".openstudio-folder-browse-posts-header-result-buttons-bottom").hide())},showSaveButtons:function(){a(".openstudio-folder-browse-posts-header-result-buttons").show(),a(".openstudio-folder-browse-posts-header-result-buttons-bottom").show()},resize:function(){f.dialogue&&f.dialogue.get("visible")&&(Y.one("body").get("winWidth")<f.dialogue.get("responsiveWidth")?(f.dialogue.makeResponsive(),a(f.CSS.SAVE_ORDER_BUTTON).removeClass("osep-smallbutton")):(a(f.CSS.SAVE_ORDER_BUTTON).addClass("osep-smallbutton"),Y.one("body").get("winWidth")>=767?f.dialogue.set("width",640):f.dialogue.set("width",500),f.dialogue.centerDialogue()))},showHideSelectButton:function(){0==f.totalavailablepost||f.selectedposts.length>0&&f.totalavailablepost<=f.selectedposts.length?a(".openstudio-folder-select-post-btn").prop("disabled",!0):a(".openstudio-folder-select-post-btn").prop("disabled",!1)},updateBackgroundRow:function(){a(".openstudio-browse-post-item").removeClass("browse-post-item-even").removeClass("browse-post-item-odd"),a(".openstudio-browse-post-item:visible:even").addClass("browse-post-item-even"),a(".openstudio-browse-post-item:visible:odd").addClass("browse-post-item-odd")}}});