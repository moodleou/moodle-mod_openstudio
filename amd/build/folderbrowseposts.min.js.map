{"version":3,"file":"folderbrowseposts.min.js","sources":["../src/folderbrowseposts.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript to manage on view page.\n *\n * @package\n * @copyright 2017 The Open University\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module mod_openstudio/folderhelper\n */\n\ndefine([\n    'jquery',\n    'core/str',\n    'core/templates',\n    'core/ajax',\n    'mod_openstudio/osdialogue',\n], function($, Str, Templates, Ajax, osDialogue) {\n    var t;\n\n    t = {\n\n        mconfig: null,\n\n        selectedposts: [],\n\n        totalavailablepost: 0,\n\n        /**\n         * List out all of css selector used in this module.\n         */\n        CSS: {\n            BROWSEPOSTLINK: '.openstudio-select-content',\n            BROWSEPOSTSSELECTEDIDS: '#browse_posts_selected_ids',\n            BROWSEPOSTSSELECTEDITEMS: '#browse_posts_selected_items',\n            SELECTPOSTBTN: '.openstudio-folder-select-post-btn',\n            BROWSEPOSTSSELECTED: '#browse_posts_selected',\n            BROWSEPOSTSCOUNTSELECTED: '#openstudio-browseposts-countcurrent',\n            REMOVELASTSELECTED: '.folder-browse-post-remove-last-selection',\n            SAVECHANGEBUTTON: '.folder-browse-post-save-change',\n            DIALOGHEADER: '.openstudio-dialogue-common-header',\n            BROWSEPOSTDIALOGUECONTAINER: '.openstudio-folder-posts-dialogue',\n            BOX_FOLDER_COMMENT: '#toggle_folder_view_folder_comments'\n        },\n\n        /**\n         * Initialise this module.\n         *\n         * @method init\n         * @param {JSON} options  The settings for this feature.\n         */\n        init: async function(options) {\n\n            /**\n             * Module config options. Passed from server side.\n             * {\n             *     cmid: int Course module ID,\n             *     folderid: int Folder ID\n             * }\n             */\n            t.mconfig = options;\n\n            // Create browse posts dialog.\n            t.dialogue = await t.createBrowseDialogue();\n\n            // Click event on select existing post link.\n            $(t.CSS.BROWSEPOSTLINK).on('click', function() {\n                t.dialogue.show();\n                Templates\n                    .render('mod_openstudio/folder_browse_posts_header', {})\n                    .done(function(html) {\n                        t.selectedposts = [];\n                        t.dialogue.setBody(html);\n                        // Enter key in a search input field\n                        $('#openstudio_search_post').keypress(function(e) {\n                            var key = e.which;\n                            if (key == 13) {\n                                t.doBrowsePosts();\n                                return false;\n                            }\n\n                            return true;\n                        });\n\n                        // Click event on search icon.\n                        $('.browse-search-icon').on('click', function() {\n                            t.doBrowsePosts();\n                        });\n\n                        t.doBrowsePosts();\n\n                        // Click event on Remove last selection button.\n                        $(t.CSS.REMOVELASTSELECTED).on('click', function() {\n                            t.removeLastPostSelected();\n                        });\n\n                        return false;\n                    });\n            });\n\n            // Toggle box comment\n            $(document).ready(this.toggleBoxComment);\n        },\n\n        /**\n         * Do browse posts.\n         *\n         * @method doBrowsePosts\n         */\n        doBrowsePosts: function() {\n            var promises = Ajax.call([{\n                methodname: 'mod_openstudio_external_browse_posts',\n                args: {\n                    cmid: t.mconfig.cmid,\n                    folderid: t.mconfig.folderid,\n                    selectedposts: $(t.CSS.BROWSEPOSTSSELECTEDIDS).val(),\n                    search: $('#openstudio_search_post').val()\n                }\n            }]);\n\n            promises[0]\n                .done(function(res) {\n                    t.totalavailablepost = res.total;\n\n                    $('#folder_total_browse_posts').html(res.foundnumberpostlabel);\n                    $('#openstudio-browseposts-total').html(res.total);\n                    $('#openstudio-browseposts-helpicon').html(res.helpicon);\n                    $('#browse_posts_searched').html(res.html);\n\n                    // Click event on select button.\n                    $(t.CSS.SELECTPOSTBTN).on('click', function() {\n                        t.selectPostToFolder(this);\n                    });\n\n                    // Click event on Save change button.\n                    $(t.CSS.SAVECHANGEBUTTON).on('click', function() {\n                        if (t.selectedposts.length) {\n                            $('#browse_posts_selected_from').submit();\n                        }\n                    });\n\n                    t.hideSaveButtons();\n\n                    t.showHideSelectButton();\n\n                    // Update odd/even background row.\n                    t.updateBackgroundRow();\n                })\n                .fail(function(ex) {\n                    window.console.error('Browse posts failed ' + ex.message);\n                });\n        },\n\n        /**\n         * Create browse posts dialogue and some events on it.\n         *\n         * @returns {Promise<Modal>}\n         * @method createBrowseDialogue\n         */\n        createBrowseDialogue: async function() {\n            /**\n             * Set header for dialog.\n             *\n             * @param {Object} dialogue\n             * @method setHeader\n             */\n            function setHeader(dialogue) {\n                var langString = 'folderbrowseposts';\n                Str\n                    .get_string(langString, 'mod_openstudio')\n                    .done(function(s) {\n                        dialogue.setTitle('<span class=\"' + t.CSS.DIALOGHEADER.replace('.', '') +\n                            '\">' + s + '</span>');\n                    });\n            }\n\n            const dialogue = await osDialogue.create({\n                isVerticallyCentered: true,\n                large: true,\n                scrollable: false,\n                templateContext: {\n                    extraClasses: t.CSS.BROWSEPOSTDIALOGUECONTAINER.replace('.', '') + ' openstudio-browseposts-dialogue',\n                },\n            });\n\n\n            setHeader(dialogue);\n\n            return dialogue;\n        },\n\n        /**\n         * Select content to folder when click on select button.\n         *\n         * @param {event} event\n         * @method selectPostToFolder\n         */\n        selectPostToFolder: function(event) {\n\n            var postid = $(event).attr('value');\n            var postimage = $('#browse_post_item_img_' + postid).attr('src');\n            var closeicon = M.util.image_url('close_button_whitecross_rgb_32px', 'mod_openstudio');\n            var itemTitle = $('#browse_post_item_name_' + postid).val();\n\n            var buttonid = 'deselect-' + postid;\n            Templates\n                .render('mod_openstudio/folder_browse_selected_post',\n                    {buttonid: buttonid, postid: postid, image: postimage, closeicon: closeicon, title: itemTitle})\n                .done(function(html) {\n                    t.doBrowsePosts();\n                    $(t.CSS.BROWSEPOSTSSELECTEDITEMS).append(html);\n\n                    // Click event on deselect button.\n                    $('#deselect-' + postid).on('click', function() {\n                        var postid = $(this).attr('value');\n\n                        t.deSelectPostToFolder(postid);\n                    });\n\n                    // Show hide select button\n                    t.showHideSelectButton();\n                });\n\n            $('#browse_post_item_' + postid).hide();\n            t.selectedposts.push(postid);\n\n            $(t.CSS.BROWSEPOSTSSELECTEDIDS).val(t.selectedposts);\n            $(t.CSS.BROWSEPOSTSSELECTED).show();\n\n            var totalselectedpost = t.selectedposts.length;\n\n            $(t.CSS.BROWSEPOSTSCOUNTSELECTED).html(totalselectedpost);\n\n            t.showSaveButtons();\n\n            // Update odd/even background row.\n            t.updateBackgroundRow();\n        },\n\n        /**\n         * Remove post from selection.\n         *\n         * @param {int} postid\n         * @method deSelectPostToFolder\n         */\n        deSelectPostToFolder: function(postid) {\n\n            $('#browse_post_item_' + postid).show();\n            $('#deselect-' + postid).remove();\n\n            t.selectedposts.splice($.inArray(postid, t.selectedposts), 1);\n            $(t.CSS.BROWSEPOSTSSELECTEDIDS).val(t.selectedposts);\n\n            var totalselectedpost = t.selectedposts.length;\n\n            $(t.CSS.BROWSEPOSTSCOUNTSELECTED).html(totalselectedpost);\n\n            if (totalselectedpost == 0) {\n                $(t.CSS.BROWSEPOSTSSELECTED).hide();\n            }\n\n            t.doBrowsePosts();\n            t.hideSaveButtons();\n\n            // Show hide select button\n            t.showHideSelectButton();\n\n            // Update odd/even background row.\n            t.updateBackgroundRow();\n        },\n\n        /**\n         * Remove last post from selection.\n         *\n         * @method removeLastPostSelected\n         */\n        removeLastPostSelected: function() {\n            var lastPostId = t.selectedposts[t.selectedposts.length - 1];\n            t.deSelectPostToFolder(lastPostId);\n\n        },\n\n        /**\n         * Hide Remove last selection/Save change button when no post added to selection.\n         *\n         * @method hideSaveButtons\n         */\n        hideSaveButtons: function() {\n            var totalselectedpost = t.selectedposts.length;\n\n            if (totalselectedpost == 0) {\n                $('.openstudio-folder-browse-posts-header-result-buttons').hide();\n                $('.openstudio-folder-browse-posts-header-result-buttons-bottom').hide();\n            }\n        },\n\n        /**\n         * Show Remove last selection/Save change button when post added to selection.\n         *\n         * @method showSaveButtons\n         */\n        showSaveButtons: function() {\n            $('.openstudio-folder-browse-posts-header-result-buttons').show();\n            $('.openstudio-folder-browse-posts-header-result-buttons-bottom').show();\n        },\n\n        /**\n         * Show/hide Select button added post equal available total post.\n         *\n         * @method showHideSelectButton\n         */\n        showHideSelectButton: function() {\n            if (t.totalavailablepost == 0 || (t.selectedposts.length > 0 && t.totalavailablepost <= t.selectedposts.length)) {\n                $('.openstudio-folder-select-post-btn').prop('disabled', true);\n            } else {\n                $('.openstudio-folder-select-post-btn').prop('disabled', false);\n            }\n        },\n\n        /**\n         * Update odd/even background color when show/hide a row.\n         *\n         * @method updateBackgroundRow\n         */\n        updateBackgroundRow: function() {\n            $(\".openstudio-browse-post-item\").removeClass('browse-post-item-even').removeClass('browse-post-item-odd');\n            $(\".openstudio-browse-post-item:visible:even\").addClass('browse-post-item-even');\n            $(\".openstudio-browse-post-item:visible:odd\").addClass('browse-post-item-odd');\n        },\n\n        /**\n         * Toggle function to show box comment.\n         */\n        toggleBoxComment: function() {\n            $(t.CSS.BOX_FOLDER_COMMENT).ready(function() {\n                const hash = window.location.hash;\n                if (hash && hash.replace(\"#\", \"\") === \"id_addcomment\") {\n                    $(t.CSS.BOX_FOLDER_COMMENT).click();\n                }\n            });\n        }\n    };\n\n    return t;\n\n});\n"],"names":["define","$","Str","Templates","Ajax","osDialogue","t","mconfig","selectedposts","totalavailablepost","CSS","BROWSEPOSTLINK","BROWSEPOSTSSELECTEDIDS","BROWSEPOSTSSELECTEDITEMS","SELECTPOSTBTN","BROWSEPOSTSSELECTED","BROWSEPOSTSCOUNTSELECTED","REMOVELASTSELECTED","SAVECHANGEBUTTON","DIALOGHEADER","BROWSEPOSTDIALOGUECONTAINER","BOX_FOLDER_COMMENT","init","async","options","dialogue","createBrowseDialogue","on","show","render","done","html","setBody","keypress","e","which","doBrowsePosts","removeLastPostSelected","document","ready","this","toggleBoxComment","call","methodname","args","cmid","folderid","val","search","res","total","foundnumberpostlabel","helpicon","selectPostToFolder","length","submit","hideSaveButtons","showHideSelectButton","updateBackgroundRow","fail","ex","window","console","error","message","create","isVerticallyCentered","large","scrollable","templateContext","extraClasses","replace","get_string","s","setTitle","setHeader","event","postid","attr","postimage","closeicon","M","util","image_url","itemTitle","buttonid","image","title","append","deSelectPostToFolder","hide","push","totalselectedpost","showSaveButtons","remove","splice","inArray","lastPostId","prop","removeClass","addClass","hash","location","click"],"mappings":"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"}