{"version":3,"file":"folderbrowseposts.min.js","sources":["../src/folderbrowseposts.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript to manage on view page.\n *\n * @package mod_openstudio\n * @copyright 2017 The Open University\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module mod_openstudio/folderhelper\n */\n\ndefine([\n    'jquery',\n    'amd/build/isotope.pkgd.min.js',\n    'core/str',\n    'core/templates',\n    'core/ajax'\n], function($, Isotope, Str, Templates, Ajax) {\n    var t;\n\n    t = {\n\n        mconfig: null,\n\n        selectedposts: [],\n\n        totalavailablepost: 0,\n\n        /**\n         * List out all of css selector used in this module.\n         */\n        CSS: {\n            BROWSEPOSTLINK: '.openstudio-select-content',\n            BROWSEPOSTSSELECTEDIDS: '#browse_posts_selected_ids',\n            BROWSEPOSTSSELECTEDITEMS: '#browse_posts_selected_items',\n            SELECTPOSTBTN: '.openstudio-folder-select-post-btn',\n            BROWSEPOSTSSELECTED: '#browse_posts_selected',\n            BROWSEPOSTSCOUNTSELECTED: '#openstudio-browseposts-countcurrent',\n            REMOVELASTSELECTED: '.folder-browse-post-remove-last-selection',\n            SAVECHANGEBUTTON: '.folder-browse-post-save-change',\n            DIALOGHEADER: '.openstudio-dialogue-common-header',\n            BROWSEPOSTDIALOGUECONTAINER: '.openstudio-folder-posts-dialogue'\n        },\n\n        /**\n         * Initialise this module.\n         *\n         * @method init\n         * @param {JSON} options  The settings for this feature.\n         */\n        init: function(options) {\n\n            /**\n             * Module config options. Passed from server side.\n             * {\n             *     cmid: int Course module ID,\n             *     folderid: int Folder ID\n             * }\n             */\n            t.mconfig = options;\n\n            // Create browse posts dialog.\n            Y.use('moodle-core-notification-dialogue', function() {\n                require(['mod_openstudio/osdialogue'], function(OSDialogue) {\n                    t.dialogue = t.createBrowseDialogue(OSDialogue);\n\n                });\n            });\n\n            // Click event on select existing post link.\n            $(t.CSS.BROWSEPOSTLINK).on('click', function() {\n                t.dialogue.show();\n                Templates\n                    .render('mod_openstudio/folder_browse_posts_header', {})\n                    .done(function(html) {\n                        t.selectedposts = [];\n                        t.dialogue.set('bodyContent', html);\n                        setTimeout(function() {\n                            t.resize();\n                        }, 200);\n                        // Enter key in a search input field\n                        $('#openstudio_search_post').keypress(function(e) {\n                            var key = e.which;\n                            if (key == 13) {\n                                t.doBrowsePosts();\n                                return false;\n                            }\n\n                            return true;\n                        });\n\n                        // Click event on search icon.\n                        $('.browse-search-icon').on('click', function() {\n                            t.doBrowsePosts();\n                        });\n\n                        t.doBrowsePosts();\n\n                        // Click event on Remove last selection button.\n                        $(t.CSS.REMOVELASTSELECTED).on('click', function() {\n                            t.removeLastPostSelected();\n                        });\n\n                        return false;\n                    });\n            });\n\n            // Responsive.\n            $(window).resize(t.resize.bind(t));\n\n        },\n\n        /**\n         * Do browse posts.\n         *\n         * @method doBrowsePosts\n         */\n        doBrowsePosts: function() {\n            var promises = Ajax.call([{\n                methodname: 'mod_openstudio_external_browse_posts',\n                args: {\n                    cmid: t.mconfig.cmid,\n                    folderid: t.mconfig.folderid,\n                    selectedposts: $(t.CSS.BROWSEPOSTSSELECTEDIDS).val(),\n                    search: $('#openstudio_search_post').val()\n                }\n            }]);\n\n            promises[0]\n                .done(function(res) {\n                    t.totalavailablepost = res.total;\n\n                    $('#folder_total_browse_posts').html(res.foundnumberpostlabel);\n                    $('#openstudio-browseposts-total').html(res.total);\n                    $('#openstudio-browseposts-helpicon').html(res.helpicon);\n                    $('#browse_posts_searched').html(res.html);\n\n                    // Click event on select button.\n                    $(t.CSS.SELECTPOSTBTN).on('click', function() {\n                        t.selectPostToFolder(this);\n                    });\n\n                    // Click event on Save change button.\n                    $(t.CSS.SAVECHANGEBUTTON).on('click', function() {\n                        if (t.selectedposts.length) {\n                            $('#browse_posts_selected_from').submit();\n                        }\n                    });\n\n                    t.hideSaveButtons();\n\n                    t.showHideSelectButton();\n                    t.resize();\n\n                    // Update odd/even background row.\n                    t.updateBackgroundRow();\n                })\n                .fail(function(ex) {\n                    window.console.error('Browse posts failed ' + ex.message);\n                });\n        },\n\n        /**\n         * Create browse posts dialogue and some events on it.\n         *\n         * @param {object} OSDialogue object\n         * @return {object} OSDialogue instance\n         * @method createBrowseDialogue\n         */\n        createBrowseDialogue: function(OSDialogue) {\n            /**\n             * Set header for dialog\n             * @method setHeader\n             */\n            function setHeader() {\n                var langstring = 'folderbrowseposts';\n                Str\n                    .get_string(langstring, 'mod_openstudio')\n                    .done(function(s) {\n                        dialogue.set('headerContent',\n                            '<span class=\"' + t.CSS.DIALOGHEADER.replace('.', '') +\n                            '\">' + s + '</span>');\n                    });\n            }\n\n            var dialogue = new OSDialogue({\n                closeButton: true,\n                visible: false,\n                centered: true,\n                modal: true,\n                responsive: true,\n                width: 640,\n                responsiveWidth: 767,\n                focusOnPreviousTargetAfterHide: true,\n                extraClasses: [\n                    t.CSS.BROWSEPOSTDIALOGUECONTAINER.replace('.', ''),\n                    'openstudio-browseposts-dialogue'\n                ]\n            });\n\n            setHeader();\n\n            return dialogue;\n        },\n\n        /**\n         * Select content to folder when click on select button.\n         *\n         * @param {event} event\n         * @method selectPostToFolder\n         */\n        selectPostToFolder: function(event) {\n\n            var postid = $(event).attr('value');\n            var postimage = $('#browse_post_item_img_' + postid).attr('src');\n            var closeicon = M.util.image_url('close_button_whitecross_rgb_32px', 'mod_openstudio');\n            var itemTitle = $('#browse_post_item_name_' + postid).val();\n\n            var buttonid = 'deselect-' + postid;\n            Templates\n                .render('mod_openstudio/folder_browse_selected_post',\n                    {buttonid: buttonid, postid: postid, image: postimage, closeicon: closeicon, title: itemTitle})\n                .done(function(html) {\n                    $(t.CSS.BROWSEPOSTSSELECTEDITEMS).append(html);\n\n                    // Click event on deselect button.\n                    $('#deselect-' + postid).on('click', function() {\n                        var postid = $(this).attr('value');\n\n                        t.deSelectPostToFolder(postid);\n                    });\n\n                    // Show hide select button\n                    t.showHideSelectButton();\n                });\n\n            $('#browse_post_item_' + postid).hide();\n            t.selectedposts.push(postid);\n\n            $(t.CSS.BROWSEPOSTSSELECTEDIDS).val(t.selectedposts);\n            $(t.CSS.BROWSEPOSTSSELECTED).show();\n\n            var totalselectedpost = t.selectedposts.length;\n\n            $(t.CSS.BROWSEPOSTSCOUNTSELECTED).html(totalselectedpost);\n\n            t.showSaveButtons();\n\n            // Update odd/even background row.\n            t.updateBackgroundRow();\n        },\n\n        /**\n         * Remove post from selection.\n         *\n         * @param {int} postid\n         * @method deSelectPostToFolder\n         */\n        deSelectPostToFolder: function(postid) {\n\n            $('#browse_post_item_' + postid).show();\n            $('#deselect-' + postid).remove();\n\n            t.selectedposts.splice($.inArray(postid, t.selectedposts), 1);\n            $(t.CSS.BROWSEPOSTSSELECTEDIDS).val(t.selectedposts);\n\n            var totalselectedpost = t.selectedposts.length;\n\n            $(t.CSS.BROWSEPOSTSCOUNTSELECTED).html(totalselectedpost);\n\n            if (totalselectedpost == 0) {\n                $(t.CSS.BROWSEPOSTSSELECTED).hide();\n            }\n\n            t.hideSaveButtons();\n\n            // Show hide select button\n            t.showHideSelectButton();\n\n            // Update odd/even background row.\n            t.updateBackgroundRow();\n        },\n\n        /**\n         * Remove last post from selection.\n         *\n         * @method removeLastPostSelected\n         */\n        removeLastPostSelected: function() {\n            var lastPostId = t.selectedposts[t.selectedposts.length - 1];\n            t.deSelectPostToFolder(lastPostId);\n\n        },\n\n        /**\n         * Hide Remove last selection/Save change button when no post added to selection.\n         *\n         * @method hideSaveButtons\n         */\n        hideSaveButtons: function() {\n            var totalselectedpost = t.selectedposts.length;\n\n            if (totalselectedpost == 0) {\n                $('.openstudio-folder-browse-posts-header-result-buttons').hide();\n                $('.openstudio-folder-browse-posts-header-result-buttons-bottom').hide();\n            }\n        },\n\n        /**\n         * Show Remove last selection/Save change button when post added to selection.\n         *\n         * @method showSaveButtons\n         */\n        showSaveButtons: function() {\n            $('.openstudio-folder-browse-posts-header-result-buttons').show();\n            $('.openstudio-folder-browse-posts-header-result-buttons-bottom').show();\n        },\n\n        /**\n         * Resize and update dialogue position.\n         * @method resize\n         */\n        resize: function() {\n            if (!t.dialogue) {\n                return;\n            }\n\n            if (t.dialogue.get('visible')) {\n                if (Y.one('body').get('winWidth') < t.dialogue.get('responsiveWidth')) {\n                    t.dialogue.makeResponsive();\n                    $(t.CSS.SAVE_ORDER_BUTTON).removeClass('osep-smallbutton');\n                } else {\n                    $(t.CSS.SAVE_ORDER_BUTTON).addClass('osep-smallbutton');\n                    if (Y.one('body').get('winWidth') >= 767) {\n                        t.dialogue.set('width', 640);\n                    } else {\n                        t.dialogue.set('width', 500);\n                    }\n                    t.dialogue.centerDialogue();\n                }\n            }\n        },\n\n        /**\n         * Show/hide Select button added post equal available total post.\n         *\n         * @method showHideSelectButton\n         */\n        showHideSelectButton: function() {\n            if (t.totalavailablepost == 0 || (t.selectedposts.length > 0 && t.totalavailablepost <= t.selectedposts.length)) {\n                $('.openstudio-folder-select-post-btn').prop('disabled', true);\n            } else {\n                $('.openstudio-folder-select-post-btn').prop('disabled', false);\n            }\n        },\n\n        /**\n         * Update odd/even background color when show/hide a row.\n         *\n         * @method updateBackgroundRow\n         */\n        updateBackgroundRow: function() {\n            $(\".openstudio-browse-post-item\").removeClass('browse-post-item-even').removeClass('browse-post-item-odd');\n            $(\".openstudio-browse-post-item:visible:even\").addClass('browse-post-item-even');\n            $(\".openstudio-browse-post-item:visible:odd\").addClass('browse-post-item-odd');\n        }\n    };\n\n    return t;\n\n});\n"],"names":["define","$","Isotope","Str","Templates","Ajax","t","mconfig","selectedposts","totalavailablepost","CSS","BROWSEPOSTLINK","BROWSEPOSTSSELECTEDIDS","BROWSEPOSTSSELECTEDITEMS","SELECTPOSTBTN","BROWSEPOSTSSELECTED","BROWSEPOSTSCOUNTSELECTED","REMOVELASTSELECTED","SAVECHANGEBUTTON","DIALOGHEADER","BROWSEPOSTDIALOGUECONTAINER","init","options","Y","use","require","OSDialogue","dialogue","createBrowseDialogue","on","show","render","done","html","set","setTimeout","resize","keypress","e","which","doBrowsePosts","removeLastPostSelected","window","bind","call","methodname","args","cmid","folderid","val","search","res","total","foundnumberpostlabel","helpicon","selectPostToFolder","this","length","submit","hideSaveButtons","showHideSelectButton","updateBackgroundRow","fail","ex","console","error","message","closeButton","visible","centered","modal","responsive","width","responsiveWidth","focusOnPreviousTargetAfterHide","extraClasses","replace","get_string","s","event","postid","attr","postimage","closeicon","M","util","image_url","itemTitle","buttonid","image","title","append","deSelectPostToFolder","hide","push","totalselectedpost","showSaveButtons","remove","splice","inArray","lastPostId","get","one","makeResponsive","SAVE_ORDER_BUTTON","removeClass","addClass","centerDialogue","prop"],"mappings":"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"}