{"version":3,"file":"folderbrowseposts.min.js","sources":["../src/folderbrowseposts.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript to manage on view page.\n *\n * @package mod_openstudio\n * @copyright 2017 The Open University\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module mod_openstudio/folderhelper\n */\n\ndefine([\n    'jquery',\n    'amd/build/isotope.pkgd.min.js',\n    'core/str',\n    'core/templates',\n    'core/ajax'\n], function($, Isotope, Str, Templates, Ajax) {\n    var t;\n\n    t = {\n\n        mconfig: null,\n\n        selectedposts: [],\n\n        totalavailablepost: 0,\n\n        /**\n         * List out all of css selector used in this module.\n         */\n        CSS: {\n            BROWSEPOSTLINK: '.openstudio-select-content',\n            BROWSEPOSTSSELECTEDIDS: '#browse_posts_selected_ids',\n            BROWSEPOSTSSELECTEDITEMS: '#browse_posts_selected_items',\n            SELECTPOSTBTN: '.openstudio-folder-select-post-btn',\n            BROWSEPOSTSSELECTED: '#browse_posts_selected',\n            BROWSEPOSTSCOUNTSELECTED: '#openstudio-browseposts-countcurrent',\n            REMOVELASTSELECTED: '.folder-browse-post-remove-last-selection',\n            SAVECHANGEBUTTON: '.folder-browse-post-save-change',\n            DIALOGHEADER: '.openstudio-dialogue-common-header',\n            BROWSEPOSTDIALOGUECONTAINER: '.openstudio-folder-posts-dialogue',\n            BOX_FOLDER_COMMENT: '#toggle_folder_view_folder_comments'\n        },\n\n        /**\n         * Initialise this module.\n         *\n         * @method init\n         * @param {JSON} options  The settings for this feature.\n         */\n        init: function(options) {\n\n            /**\n             * Module config options. Passed from server side.\n             * {\n             *     cmid: int Course module ID,\n             *     folderid: int Folder ID\n             * }\n             */\n            t.mconfig = options;\n\n            // Create browse posts dialog.\n            Y.use('moodle-core-notification-dialogue', function() {\n                require(['mod_openstudio/osdialogue'], function(OSDialogue) {\n                    t.dialogue = t.createBrowseDialogue(OSDialogue);\n\n                });\n            });\n\n            // Click event on select existing post link.\n            $(t.CSS.BROWSEPOSTLINK).on('click', function() {\n                t.dialogue.show();\n                Templates\n                    .render('mod_openstudio/folder_browse_posts_header', {})\n                    .done(function(html) {\n                        t.selectedposts = [];\n                        t.dialogue.set('bodyContent', html);\n                        setTimeout(function() {\n                            t.resize();\n                        }, 200);\n                        // Enter key in a search input field\n                        $('#openstudio_search_post').keypress(function(e) {\n                            var key = e.which;\n                            if (key == 13) {\n                                t.doBrowsePosts();\n                                return false;\n                            }\n\n                            return true;\n                        });\n\n                        // Click event on search icon.\n                        $('.browse-search-icon').on('click', function() {\n                            t.doBrowsePosts();\n                        });\n\n                        t.doBrowsePosts();\n\n                        // Click event on Remove last selection button.\n                        $(t.CSS.REMOVELASTSELECTED).on('click', function() {\n                            t.removeLastPostSelected();\n                        });\n\n                        return false;\n                    });\n            });\n\n            // Responsive.\n            $(window).resize(t.resize.bind(t));\n\n            // Toggle box comment\n            $(document).ready(this.toggleBoxComment);\n        },\n\n        /**\n         * Do browse posts.\n         *\n         * @method doBrowsePosts\n         */\n        doBrowsePosts: function() {\n            var promises = Ajax.call([{\n                methodname: 'mod_openstudio_external_browse_posts',\n                args: {\n                    cmid: t.mconfig.cmid,\n                    folderid: t.mconfig.folderid,\n                    selectedposts: $(t.CSS.BROWSEPOSTSSELECTEDIDS).val(),\n                    search: $('#openstudio_search_post').val()\n                }\n            }]);\n\n            promises[0]\n                .done(function(res) {\n                    t.totalavailablepost = res.total;\n\n                    $('#folder_total_browse_posts').html(res.foundnumberpostlabel);\n                    $('#openstudio-browseposts-total').html(res.total);\n                    $('#openstudio-browseposts-helpicon').html(res.helpicon);\n                    $('#browse_posts_searched').html(res.html);\n\n                    // Click event on select button.\n                    $(t.CSS.SELECTPOSTBTN).on('click', function() {\n                        t.selectPostToFolder(this);\n                    });\n\n                    // Click event on Save change button.\n                    $(t.CSS.SAVECHANGEBUTTON).on('click', function() {\n                        if (t.selectedposts.length) {\n                            $('#browse_posts_selected_from').submit();\n                        }\n                    });\n\n                    t.hideSaveButtons();\n\n                    t.showHideSelectButton();\n                    t.resize();\n\n                    // Update odd/even background row.\n                    t.updateBackgroundRow();\n                })\n                .fail(function(ex) {\n                    window.console.error('Browse posts failed ' + ex.message);\n                });\n        },\n\n        /**\n         * Create browse posts dialogue and some events on it.\n         *\n         * @param {object} OSDialogue object\n         * @return {object} OSDialogue instance\n         * @method createBrowseDialogue\n         */\n        createBrowseDialogue: function(OSDialogue) {\n            /**\n             * Set header for dialog\n             * @method setHeader\n             */\n            function setHeader() {\n                var langstring = 'folderbrowseposts';\n                Str\n                    .get_string(langstring, 'mod_openstudio')\n                    .done(function(s) {\n                        dialogue.set('headerContent',\n                            '<span class=\"' + t.CSS.DIALOGHEADER.replace('.', '') +\n                            '\">' + s + '</span>');\n                    });\n            }\n\n            var dialogue = new OSDialogue({\n                closeButton: true,\n                visible: false,\n                centered: true,\n                modal: true,\n                responsive: true,\n                width: 640,\n                responsiveWidth: 767,\n                focusOnPreviousTargetAfterHide: true,\n                extraClasses: [\n                    t.CSS.BROWSEPOSTDIALOGUECONTAINER.replace('.', ''),\n                    'openstudio-browseposts-dialogue'\n                ]\n            });\n\n            setHeader();\n\n            return dialogue;\n        },\n\n        /**\n         * Select content to folder when click on select button.\n         *\n         * @param {event} event\n         * @method selectPostToFolder\n         */\n        selectPostToFolder: function(event) {\n\n            var postid = $(event).attr('value');\n            var postimage = $('#browse_post_item_img_' + postid).attr('src');\n            var closeicon = M.util.image_url('close_button_whitecross_rgb_32px', 'mod_openstudio');\n            var itemTitle = $('#browse_post_item_name_' + postid).val();\n\n            var buttonid = 'deselect-' + postid;\n            Templates\n                .render('mod_openstudio/folder_browse_selected_post',\n                    {buttonid: buttonid, postid: postid, image: postimage, closeicon: closeicon, title: itemTitle})\n                .done(function(html) {\n                    $(t.CSS.BROWSEPOSTSSELECTEDITEMS).append(html);\n\n                    // Click event on deselect button.\n                    $('#deselect-' + postid).on('click', function() {\n                        var postid = $(this).attr('value');\n\n                        t.deSelectPostToFolder(postid);\n                    });\n\n                    // Show hide select button\n                    t.showHideSelectButton();\n                });\n\n            $('#browse_post_item_' + postid).hide();\n            t.selectedposts.push(postid);\n\n            $(t.CSS.BROWSEPOSTSSELECTEDIDS).val(t.selectedposts);\n            $(t.CSS.BROWSEPOSTSSELECTED).show();\n\n            var totalselectedpost = t.selectedposts.length;\n\n            $(t.CSS.BROWSEPOSTSCOUNTSELECTED).html(totalselectedpost);\n\n            t.showSaveButtons();\n\n            // Update odd/even background row.\n            t.updateBackgroundRow();\n        },\n\n        /**\n         * Remove post from selection.\n         *\n         * @param {int} postid\n         * @method deSelectPostToFolder\n         */\n        deSelectPostToFolder: function(postid) {\n\n            $('#browse_post_item_' + postid).show();\n            $('#deselect-' + postid).remove();\n\n            t.selectedposts.splice($.inArray(postid, t.selectedposts), 1);\n            $(t.CSS.BROWSEPOSTSSELECTEDIDS).val(t.selectedposts);\n\n            var totalselectedpost = t.selectedposts.length;\n\n            $(t.CSS.BROWSEPOSTSCOUNTSELECTED).html(totalselectedpost);\n\n            if (totalselectedpost == 0) {\n                $(t.CSS.BROWSEPOSTSSELECTED).hide();\n            }\n\n            t.hideSaveButtons();\n\n            // Show hide select button\n            t.showHideSelectButton();\n\n            // Update odd/even background row.\n            t.updateBackgroundRow();\n        },\n\n        /**\n         * Remove last post from selection.\n         *\n         * @method removeLastPostSelected\n         */\n        removeLastPostSelected: function() {\n            var lastPostId = t.selectedposts[t.selectedposts.length - 1];\n            t.deSelectPostToFolder(lastPostId);\n\n        },\n\n        /**\n         * Hide Remove last selection/Save change button when no post added to selection.\n         *\n         * @method hideSaveButtons\n         */\n        hideSaveButtons: function() {\n            var totalselectedpost = t.selectedposts.length;\n\n            if (totalselectedpost == 0) {\n                $('.openstudio-folder-browse-posts-header-result-buttons').hide();\n                $('.openstudio-folder-browse-posts-header-result-buttons-bottom').hide();\n            }\n        },\n\n        /**\n         * Show Remove last selection/Save change button when post added to selection.\n         *\n         * @method showSaveButtons\n         */\n        showSaveButtons: function() {\n            $('.openstudio-folder-browse-posts-header-result-buttons').show();\n            $('.openstudio-folder-browse-posts-header-result-buttons-bottom').show();\n        },\n\n        /**\n         * Resize and update dialogue position.\n         * @method resize\n         */\n        resize: function() {\n            if (!t.dialogue) {\n                return;\n            }\n\n            if (t.dialogue.get('visible')) {\n                if (Y.one('body').get('winWidth') < t.dialogue.get('responsiveWidth')) {\n                    t.dialogue.makeResponsive();\n                    $(t.CSS.SAVE_ORDER_BUTTON).removeClass('osep-smallbutton');\n                } else {\n                    $(t.CSS.SAVE_ORDER_BUTTON).addClass('osep-smallbutton');\n                    if (Y.one('body').get('winWidth') >= 767) {\n                        t.dialogue.set('width', 640);\n                    } else {\n                        t.dialogue.set('width', 500);\n                    }\n                    t.dialogue.centerDialogue();\n                }\n            }\n        },\n\n        /**\n         * Show/hide Select button added post equal available total post.\n         *\n         * @method showHideSelectButton\n         */\n        showHideSelectButton: function() {\n            if (t.totalavailablepost == 0 || (t.selectedposts.length > 0 && t.totalavailablepost <= t.selectedposts.length)) {\n                $('.openstudio-folder-select-post-btn').prop('disabled', true);\n            } else {\n                $('.openstudio-folder-select-post-btn').prop('disabled', false);\n            }\n        },\n\n        /**\n         * Update odd/even background color when show/hide a row.\n         *\n         * @method updateBackgroundRow\n         */\n        updateBackgroundRow: function() {\n            $(\".openstudio-browse-post-item\").removeClass('browse-post-item-even').removeClass('browse-post-item-odd');\n            $(\".openstudio-browse-post-item:visible:even\").addClass('browse-post-item-even');\n            $(\".openstudio-browse-post-item:visible:odd\").addClass('browse-post-item-odd');\n        },\n\n        /**\n         * Toggle function to show box comment.\n         */\n        toggleBoxComment: function() {\n            $(t.CSS.BOX_FOLDER_COMMENT).ready(function() {\n                const hash = window.location.hash;\n                if (hash && hash.replace(\"#\", \"\") === \"id_addcomment\") {\n                    $(t.CSS.BOX_FOLDER_COMMENT).click();\n                }\n            });\n        }\n    };\n\n    return t;\n\n});\n"],"names":["define","$","Isotope","Str","Templates","Ajax","t","mconfig","selectedposts","totalavailablepost","CSS","BROWSEPOSTLINK","BROWSEPOSTSSELECTEDIDS","BROWSEPOSTSSELECTEDITEMS","SELECTPOSTBTN","BROWSEPOSTSSELECTED","BROWSEPOSTSCOUNTSELECTED","REMOVELASTSELECTED","SAVECHANGEBUTTON","DIALOGHEADER","BROWSEPOSTDIALOGUECONTAINER","BOX_FOLDER_COMMENT","init","options","Y","use","require","OSDialogue","dialogue","createBrowseDialogue","on","show","render","done","html","set","setTimeout","resize","keypress","e","which","doBrowsePosts","removeLastPostSelected","window","bind","document","ready","this","toggleBoxComment","call","methodname","args","cmid","folderid","val","search","res","total","foundnumberpostlabel","helpicon","selectPostToFolder","length","submit","hideSaveButtons","showHideSelectButton","updateBackgroundRow","fail","ex","console","error","message","closeButton","visible","centered","modal","responsive","width","responsiveWidth","focusOnPreviousTargetAfterHide","extraClasses","replace","get_string","s","event","postid","attr","postimage","closeicon","M","util","image_url","itemTitle","buttonid","image","title","append","deSelectPostToFolder","hide","push","totalselectedpost","showSaveButtons","remove","splice","inArray","lastPostId","get","one","makeResponsive","SAVE_ORDER_BUTTON","removeClass","addClass","centerDialogue","prop","hash","location","click"],"mappings":"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"}