/**
 * JavaScript to manage content detail page.
 *
 * @package
 * @copyright 2017 The Open University
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_openstudio/contentpage",["jquery","core/ajax","core/str","core/modal","core/modal_events","core/templates","core/config","require"],(function($,Ajax,Str,Modal,ModalEvents,Templates,Config,require){var t;return t={dialogue:null,delete_item:null,mconfig:null,init:function(options){$.fx.off=!0,t.mconfig=options,Y.use("moodle-core-notification-dialogue",(function(){require(["mod_openstudio/osdialogue"],(function(osDialogue){t.archiveDialogue=t.createArchiveDialogue(osDialogue),t.deleteContentDialogue=t.createDeleteContentDialogue(osDialogue)}))})),t.createMaximizeModal(),$("#openstudio_content_view_maximize").on("click",t.toogleContentModal),$("body").delegate("#openstudio_content_view_minimize","click",t.toogleContentModal),$("body").delegate(".openstudio-modal-content-close","click",t.toogleContentModal);var contentViewMapCanvas=$("#openstudio_content_view_map_canvas");contentViewMapCanvas.length&&t.showGoogleMap(contentViewMapCanvas),$("#id_archivebutton").on("click",(function(e){e.preventDefault(),t.archiveDialogue.show()})),$(".openstudio-delete-content-version").on("click",(function(e){e.preventDefault(),t.delete_item=$(this),t.deleteContentDialogue.show()})),$(".openstudio-content-view-flag-icon").bind("click",(function(){t.doFlagContent($(this))})),$(".openstudio-content-view-icon-active-image").bind("mouseover",(function(){t.doHoverFlagIcon($(this))})),$(".openstudio-request-feedback-button").bind("click",(function(){t.doFlagContent($(this))})),$(document).ready(t.showCommentBox)},createMaximizeModal:function(){Templates.render("mod_openstudio/content_modal",{title:$(".openstudio-content-view-title").text(),body:$(".openstudio-content-view-file").html(),date:$(".openstudio-content-view-date").html(),isiframecontent:$(".openstudio-content-view-file").find("iframe").length>0}).done((function(html){t.modal=new Modal(html),t.modal.setLarge()}))},toogleContentModal:function(){t.modal&&(t.modal.isVisible()?t.modal.hide():(t.modal.show(),t.modal.getRoot().on(ModalEvents.shown,(function(e){"modal:shown"===e.type&&$(".openstudio-modal-content-close")[0].scrollIntoView(),$(".openstudio-modal-content-close, #openstudio_content_view_minimize").keydown((function(e){if(13==e.keyCode)return t.modal.hide(),$("#openstudio_content_view_maximize").focus(),!1}))}))),$("body").toggleClass("openstudio-lockscroll"))},showGoogleMap:function(contentViewMapCanvas){var gpslat=contentViewMapCanvas.attr("data-gpslat"),gpslng=contentViewMapCanvas.attr("data-gpslng");if(gpslat&&gpslng){var myLatLng={lat:parseFloat(gpslat),lng:parseFloat(gpslng)};if("undefined"!=typeof google&&void 0!==google.maps){var map=new google.maps.Map(document.getElementById("openstudio_content_view_map_canvas"),{center:myLatLng,zoom:14});new google.maps.Marker({position:myLatLng,map:map})}}},doFlagContent:function(event){Ajax.call([{methodname:"mod_openstudio_external_flag_content",args:{cmid:event.attr("data-cmid"),cid:event.attr("data-cid"),fid:event.attr("data-fid"),mode:event.attr("data-mode")}}])[0].done((function(res){if(res.success){var flagcontainer=$("#content_view_icon_"+event.attr("data-cid")+"_"+res.fid);flagcontainer.attr("data-mode",res.mode),res.iscontentflagrequestfeedback?(flagcontainer.html(res.flagtext),$("#openstudio_item_request_feedback").removeClass(res.flagremoveclass).addClass(res.flagaddclass)):(flagcontainer.find(".openstudio-content-view-icon-text").text(res.flagtext),flagcontainer.toggleClass("openstudio-content-view-icon-active","off"==res.mode),flagcontainer.attr("title",res.accessiblemessage))}})).fail((function(ex){window.console.error("Error saving social flag "+ex.message)}))},doHoverFlagIcon:function(event){var parent=event.parents(".openstudio-content-view-flag-icon");event.find("img").attr("title",parent.attr("title"))},setHeader:function(dialogue,label){Str.get_string(label,"mod_openstudio").done((function(s){dialogue.set("headerContent",'<span class="openstudio-dialogue-common-header">'+s+"</span>")}))},setBody:function(dialogue,label){Str.get_string(label,"mod_openstudio").done((function(s){dialogue.set("bodyContent","<span>"+s+"</span>")}))},createArchiveDialogue:function(osDialogue){var dialogue=new osDialogue({closeButton:!0,visible:!1,centered:!0,responsive:!0,responsiveWidth:767,modal:!0,focusOnPreviousTargetAfterHide:!0,width:521});t.setHeader(dialogue,"archivedialogheader"),t.setBody(dialogue,"modulejsdialogcontentarchiveconfirm");var archiveBtnProperty={name:"archive",classNames:"openstudio-archive-yes-btn",events:{click:function(){t.redirectPostRequest({url:$("#contentversionlink").val(),data:{archiveversion:1}})}}},cancelBtnProperty={name:"cancel",classNames:"openstudio-archive-no-btn",action:"hide"};return Str.get_strings([{key:"contentactionarchivepost",component:"mod_openstudio"},{key:"modulejsdialogcancel",component:"mod_openstudio"}]).done((function(s){archiveBtnProperty.label=s[0],cancelBtnProperty.label=s[1],dialogue.addButton(archiveBtnProperty,["footer"]),dialogue.addButton(cancelBtnProperty,["footer"])})),dialogue},createDeleteContentDialogue:function(osDialogue){var dialogue=new osDialogue({closeButton:!0,visible:!1,centered:!0,responsive:!0,responsiveWidth:767,modal:!0,focusOnPreviousTargetAfterHide:!0,width:521});t.setHeader(dialogue,"deletearchiveversionheader"),t.setBody(dialogue,"deletearchiveversionheaderconfirm");var deleteBtnProperty={name:"delete",classNames:"openstudio-delete-btn",events:{click:function(){var delete_item=t.delete_item;Ajax.call([{methodname:"mod_openstudio_external_delete_version",args:{cmid:delete_item.attr("data-cmid"),cid:delete_item.attr("data-cid"),cvid:delete_item.attr("data-cvid")}}])[0].done((function(){$(".openstudio-cancel-btn").trigger("click"),$("#contentcurrenteversionurl").length>0?window.location.href=$("#contentcurrenteversionurl").val():($("#content_version_id_"+delete_item.attr("data-cvid")).remove(),0==$(".openstudio-content-view-version-detail").length&&$("#openstudio_content_view_post_archive_panel").remove())})).fail((function(ex){window.console.error("Error delete content version"+ex.message)}))}}},cancelBtnProperty={name:"cancel",classNames:"openstudio-cancel-btn",action:"hide"};return Str.get_strings([{key:"modulejsdialogdelete",component:"mod_openstudio"},{key:"modulejsdialogcancel",component:"mod_openstudio"}]).done((function(s){deleteBtnProperty.label=s[0],cancelBtnProperty.label=s[1],dialogue.addButton(deleteBtnProperty,["footer"]),dialogue.addButton(cancelBtnProperty,["footer"])})),dialogue},redirectPostRequest:function(options){var form=$("<form></form>");form.attr({method:"POST",action:options.url,style:"display: none;"}),$.each(options.data,(function(key,value){var field=$("<input/>");field.attr("type","hidden"),field.attr("name",key),field.attr("value",value),form.append(field)})),$(form).appendTo("body").submit()},showCommentBox:function(){const urlParams=new URLSearchParams(window.location.search),idAddComment=$("#id_addcomment");if(1==urlParams.get("addcomment")){const folderComment=$("#toggle_folder_view_folder_comments");folderComment&&folderComment.click(),idAddComment.click(),folderComment?$("#openstudio_folder_view_folder_comments").on("shown.bs.collapse",(function(){t.scrollToEle()})):t.scrollToEle()}},scrollToEle:function(){const element=$("#openstudio-comment-form-body");$("html, body").animate({scrollTop:$(element).offset().top},800)}}}));

//# sourceMappingURL=contentpage.min.js.map