/**
 * JavaScript to order posts on folder.
 *
 * @package
 * @copyright 2017 The Open University
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_openstudio/orderposts",["jquery","core/ajax","core/str","mod_openstudio/osdialogue"],(function($,Ajax,Str,osDialogue){var t;return t={mconfig:null,dialogue:null,CSS:{ORDER_POSTS_BUTTON:"#id_orderpost",MOVE_UP_BUTTON:".openstudio-orderpost-item-moveup-button",MOVE_DOWN_BUTTON:".openstudio-orderpost-item-movedown-button",SAVE_ORDER_BUTTON:".openstudio-orderpost-save-button",ORDER_NUMBER_INPUT:".openstudio-orderpost-item-order-number-input",ITEM_CONTAINER:".openstudio-orderpost-item",ITEM_ORDER:".openstudio-orderpost-item-order",ORDER_POSTS_DIALOGUE_CONTAINER:".openstudio-orderposts-dialogue"},init:async function(options){t.mconfig=options,t.dialogue=await t.createOrderPostsDialogue(),$(t.CSS.ORDER_POSTS_BUTTON).on("click",(function(){if(t.dialogue){$(".openstudio-folder-posts-dialogue .openstudio-orderpost").remove(),t.setBody(t.dialogue),t.dialogue.show();var listorder=t.getListOrderPost(),sortedlistorderpost=[];$.each(listorder,(function(index,value){sortedlistorderpost[index]=value[0]})),t.mconfig.listorder=sortedlistorderpost.join(",")}})),$("body").delegate(t.CSS.SAVE_ORDER_BUTTON,"click",t.saveOrder).delegate(t.CSS.MOVE_UP_BUTTON,"click",t.moveUp).delegate(t.CSS.MOVE_DOWN_BUTTON,"click",t.moveDown).delegate(t.CSS.ORDER_NUMBER_INPUT,"keyup",t.handleNumberInputEnter).delegate(t.CSS.ORDER_NUMBER_INPUT,"blur",t.handleNumberInputBlur)},createOrderPostsDialogue:async function(){const dialogue=await osDialogue.create({isVerticallyCentered:!0,templateContext:{extraClasses:t.CSS.ORDER_POSTS_DIALOGUE_CONTAINER.replace(".","")+" openstudio-folder-posts-dialogue"}});return function(dialogue){Str.get_string("folderorderpost","mod_openstudio").done((function(s){dialogue.setTitle("<span>"+s+"</span>")}))}(dialogue),t.setBody(dialogue),dialogue},setBody:function(dialogue){M.util.js_pending("openstudioGetOrderPostsFolderContent");Ajax.call([{methodname:"mod_openstudio_external_get_order_posts",args:{cmid:t.mconfig.cmid,folderid:t.mconfig.folderid}}])[0].done((function(res){dialogue.setBody(res.html),t.disableFirstLastButton(),$(document).ready(t.disableContentButton),t.checkReorder(),t.inputPosition(),$(t.CSS.SAVE_ORDER_BUTTON).attr("disabled","disabled")})).always((function(){M.util.js_complete("openstudioGetOrderPostsFolderContent")})).fail((function(ex){window.console.error("Log request failed "+ex.message)}))},moveUp:function(){var item=$(this).closest(t.CSS.ITEM_CONTAINER),itemOrder=item.find(t.CSS.ITEM_ORDER).attr("data-order");itemOrder=parseInt(itemOrder),t.swapItems(itemOrder,itemOrder-1,item)},moveDown:function(){var item=$(this).closest(t.CSS.ITEM_CONTAINER),itemOrder=item.find(t.CSS.ITEM_ORDER).attr("data-order");itemOrder=parseInt(itemOrder),t.swapItems(itemOrder,itemOrder+1,item)},moveTo:function(){var desiredOrder=$(this).val();if(!(desiredOrder<=0||desiredOrder>t.mconfig.total)){var item=$(this).closest(t.CSS.ITEM_CONTAINER),itemOrder=item.find(t.CSS.ITEM_ORDER).attr("data-order");itemOrder=parseInt(itemOrder);var lastOrder=$(t.CSS.ITEM_CONTAINER).last().find(t.CSS.ITEM_ORDER).attr("data-order");lastOrder=parseInt(lastOrder);var currentorder=$("div[data-order="+itemOrder+"]").hasClass("openstudio-orderpost-item-canreorder"),itemMove=$("div[data-order="+desiredOrder+"]").hasClass("openstudio-orderpost-item-canreorder");currentorder&&itemMove?Str.get_string("foldercontentcannotreorder","mod_openstudio").done((function(s){t.showErrorMessage(s)})):(desiredOrder>lastOrder&&(desiredOrder=lastOrder),desiredOrder<1&&(desiredOrder=1),t.swapItems(itemOrder,desiredOrder,item))}},saveOrder:function(){$(t.CSS.ORDER_NUMBER_INPUT).each((function(){var order=$(this).val().trim(),item=$(this).closest(t.CSS.ITEM_CONTAINER),itemOrder=item.find(t.CSS.ITEM_ORDER).attr("data-order");order!=(itemOrder=parseInt(itemOrder))&&t.swapItems(itemOrder,order,item)})),M.util.js_pending("openstudioOrderPostsFolderContent");var textlistcontent=t.getListOrderPost(!0),newlistcontent={},currentorder="",neworder="";$.each(textlistcontent,(function(index,value){neworder=value[0],currentorder=value[1],neworder!=currentorder&&(newlistcontent[currentorder-1]=neworder)})),textlistcontent="",$.each(newlistcontent,(function(index,value){textlistcontent+=index+"-"+value+","})),textlistcontent=textlistcontent.substr(0,textlistcontent.length-1),Ajax.call([{methodname:"mod_openstudio_external_order_posts",args:{cmid:t.mconfig.cmid,folderid:t.mconfig.folderid,listorderporst:textlistcontent}}])[0].done((function(){window.location.reload()})).always((function(){M.util.js_complete("openstudioOrderPostsFolderContent")})).fail((function(ex){window.console.error("Log request failed "+ex.message)}))},swapItems:function(fromOrderNumber,toOrderNumber,element){var reoderLock=!1,targetElement=$(t.CSS.ITEM_ORDER+'[data-order="'+toOrderNumber+'"]');if(element.find(t.CSS.ITEM_ORDER).hasClass("openstudio-orderpost-item-canreorder")&&(reoderLock=t.checkReorderLock(fromOrderNumber,toOrderNumber)),1!=reoderLock){targetElement.length>0&&(fromOrderNumber<toOrderNumber?targetElement.closest(t.CSS.ITEM_CONTAINER).after(element):targetElement.closest(t.CSS.ITEM_CONTAINER).before(element),$(t.CSS.ITEM_CONTAINER).each((function(index){var orderNumberString=(index+=1)<10?"0"+index:""+index;$(this).find(t.CSS.ITEM_ORDER).attr("data-order",index).text(orderNumberString),$(this).find(t.CSS.ORDER_NUMBER_INPUT).val(index);var moveUpButtonTitle=$(this).find(t.CSS.MOVE_UP_BUTTON).attr("title"),moveUpButtonOrderArr=moveUpButtonTitle.match(/([0-9-.]+)/g);if(null!==moveUpButtonOrderArr){var moveUpButtonOrder=moveUpButtonOrderArr[moveUpButtonOrderArr.length-1],moveUpButtonNewTitle=moveUpButtonTitle.replace(moveUpButtonOrder,index-1+".");$(this).find(t.CSS.MOVE_UP_BUTTON).attr("title",moveUpButtonNewTitle)}var moveDownButtonTitle=$(this).find(t.CSS.MOVE_DOWN_BUTTON).attr("title"),moveDownButtonOrderArr=moveDownButtonTitle.match(/([0-9-.]+)/g);if(null!==moveDownButtonOrderArr){var moveDownButtonOrder=moveDownButtonOrderArr[moveDownButtonOrderArr.length-1],moveDownButtonNewTitle=moveDownButtonTitle.replace(moveDownButtonOrder,index+1+".");$(this).find(t.CSS.MOVE_DOWN_BUTTON).attr("title",moveDownButtonNewTitle)}})));var currentorder=t.mconfig.listorder,sortable=t.getListOrderPost(),sortedlistorderpost=[];$.each(sortable,(function(index,value){sortedlistorderpost[index]=value[0]}));var neworder=sortedlistorderpost.join(",");t.enableSaveOrder(currentorder,neworder),t.checkReorder(),t.disableContentButton(),t.disableFirstLastButton()}else Str.get_string("foldercontentcannotreorder","mod_openstudio").done((function(s){t.showErrorMessage(s)}))},getListOrderPost:function(filterBookContent){var listorderporst={};$(t.CSS.ITEM_CONTAINER).each((function(){var orderElement=$(this).find(t.CSS.ITEM_ORDER);filterBookContent&&orderElement.hasClass("openstudio-orderpost-item-book")||(listorderporst[orderElement.attr("data-order")]=orderElement.attr("data-original-order"))}));var sortable=[];for(var order in listorderporst)sortable.push([order,listorderporst[order]]);return sortable.sort((function(a,b){return a[1]-b[1]})),sortable},enableSaveOrder:function(currentorder,neworder){currentorder!=neworder?$(t.CSS.SAVE_ORDER_BUTTON).removeAttr("disabled"):$(t.CSS.SAVE_ORDER_BUTTON).attr("disabled","disabled")},inputPosition:function(){$(document).ready((function(){$(t.CSS.ORDER_NUMBER_INPUT).keyup((function(){t.enableSaveOrder($(this).val().length,0);var order=$(this).val();order&&!$.isNumeric(order)?Str.get_string("errormoveslotnumeric","mod_openstudio").done((function(s){t.showErrorMessage(s)})):parseInt(order)>t.mconfig.total||parseInt(order)<=0?Str.get_string("errormoveslotoutofrange","mod_openstudio").done((function(s){t.showErrorMessage(s)})):t.showErrorMessage(""),$(this).val(order)}))}))},disableFirstLastButton:function(){$(t.CSS.MOVE_UP_BUTTON+":not(.openstudio-orderpost-item-book)").removeAttr("disabled"),$(t.CSS.MOVE_DOWN_BUTTON+":not(.openstudio-orderpost-item-book)").removeAttr("disabled"),$(t.CSS.MOVE_UP_BUTTON+":first").attr("disabled","disabled"),$(t.CSS.MOVE_DOWN_BUTTON+":last").attr("disabled","disabled")},disableContentButton:function(){$(".openstudio-orderpost-item-book").attr("disabled","disabled")},checkReorder:function(){$(t.CSS.ITEM_CONTAINER).each((function(){$(this).find(t.CSS.ITEM_ORDER).hasClass("openstudio-orderpost-item-canreorder")&&($(this).next().find(t.CSS.ITEM_ORDER).hasClass("openstudio-orderpost-item-canreorder")?t.disableContentButton():t.showErrorMessage(""))}))},checkReorderLock:function(currentOrderNumber,toOrderNumber){var firstitem="",lastitem="",classCheck="openstudio-orderpost-item-canreorder";if(currentOrderNumber>toOrderNumber?(firstitem=toOrderNumber,lastitem=currentOrderNumber):(firstitem=currentOrderNumber,lastitem=toOrderNumber),currentOrderNumber<toOrderNumber)for(firstitem+=1;firstitem<=lastitem;){if($(t.CSS.ITEM_ORDER+'[data-order="'+firstitem+'"]').hasClass(classCheck))return!0;firstitem++}else for(lastitem-=1;lastitem>=firstitem;){if($(t.CSS.ITEM_ORDER+'[data-order="'+lastitem+'"]').hasClass(classCheck))return!0;lastitem--}return!1},showErrorMessage:function(message){$(".openstudio-message-error").text(message)},handleNumberInputEnter:function(e){13===e.which&&t.moveTo.call(this)},handleNumberInputBlur:function(){t.moveTo.call(this)}}}));

//# sourceMappingURL=orderposts.min.js.map